function y = sphharm( l, m, theta, phi )% SPHHARM  Spherical harmonics Ylm( theta, phi )% %     y = sphharm( l, m, theta, phi )% %     l is the order, m is the degree of the spherical harmonic% %     ( theta, phi ) are polar coordinates in radians%       theta is the declination, i.e., angle relative to the north pole%       phi is the azimuth% %     The spherical harmonics generated by this function are%     complex-valued and orthonormal.% part 1.  calculate harmonic with positive degree, i.e., Y_l_abs(m)% calculate normalizing constantmpos = abs(m);c = sqrt( ((2*l+1)/(4*pi))*factorial(l-mpos)/factorial(l+mpos) );% calculate associated Legendre polynomial termPlm = legendre(l,cos(theta(:)'));Plm = Plm(mpos+1,:);% calculate exponential terme = exp(1i*mpos*phi(:)');% combine and reshapey = reshape(c*Plm.*e,size(theta));% part 2.  adjust negative degree harmonicsif m<0    y = power(-1,m)*conj(y);endreturn